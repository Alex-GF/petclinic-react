<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PetClinic - TFG - Rafael Sanabria Espárrago</a> &gt; <a href="index.source.html" class="el_package">org.springframework.samples.petclinic.auth</a> &gt; <span class="el_source">AuthService.java</span></div><h1>AuthService.java</h1><pre class="source lang-java linenums">package org.springframework.samples.petclinic.auth;

import java.util.ArrayList;

import javax.transaction.Transactional;
import javax.validation.Valid;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.samples.petclinic.owner.Owner;
import org.springframework.samples.petclinic.owner.OwnerService;
import org.springframework.samples.petclinic.owner.PricingPlan;
import org.springframework.samples.petclinic.user.Authorities;
import org.springframework.samples.petclinic.user.AuthoritiesService;
import org.springframework.samples.petclinic.user.User;
import org.springframework.samples.petclinic.user.UserService;
import org.springframework.samples.petclinic.vet.Specialty;
import org.springframework.samples.petclinic.vet.Vet;
import org.springframework.samples.petclinic.vet.VetService;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import petclinic.payload.request.SignupRequest;

@Service
public class AuthService {

	private final PasswordEncoder encoder;
	private final AuthoritiesService authoritiesService;
	private final UserService userService;
	private final OwnerService ownerService;
	private final VetService vetService;

	@Autowired
	public AuthService(PasswordEncoder encoder, AuthoritiesService authoritiesService, UserService userService,
<span class="fc" id="L35">			OwnerService ownerService, VetService vetService) {</span>
<span class="fc" id="L36">		this.encoder = encoder;</span>
<span class="fc" id="L37">		this.authoritiesService = authoritiesService;</span>
<span class="fc" id="L38">		this.userService = userService;</span>
<span class="fc" id="L39">		this.ownerService = ownerService;</span>
<span class="fc" id="L40">		this.vetService = vetService;</span>

<span class="fc" id="L42">	}</span>

	@Transactional
	public void createUser(@Valid SignupRequest request) {
<span class="fc" id="L46">		User user = new User();</span>
<span class="fc" id="L47">		user.setUsername(request.getUsername());</span>
<span class="fc" id="L48">		user.setPassword(encoder.encode(request.getPassword()));</span>
<span class="fc" id="L49">		String strRoles = request.getAuthority();</span>
		Authorities role;

<span class="fc bfc" id="L52" title="All 3 branches covered.">		switch (strRoles.toLowerCase()) {</span>
		case &quot;admin&quot;:
<span class="fc" id="L54">			role = authoritiesService.findByAuthority(&quot;ADMIN&quot;);</span>
<span class="fc" id="L55">			user.setAuthority(role);</span>
<span class="fc" id="L56">			userService.saveUser(user);</span>
<span class="fc" id="L57">			break;</span>
		case &quot;vet&quot;:
<span class="fc" id="L59">			role = authoritiesService.findByAuthority(&quot;VET&quot;);</span>
<span class="fc" id="L60">			user.setAuthority(role);</span>
<span class="fc" id="L61">			userService.saveUser(user);</span>
<span class="fc" id="L62">			Vet vet = new Vet();</span>
<span class="fc" id="L63">			vet.setFirstName(request.getFirstName());</span>
<span class="fc" id="L64">			vet.setLastName(request.getLastName());</span>
<span class="fc" id="L65">			vet.setCity(request.getCity());</span>
<span class="fc" id="L66">			vet.setSpecialties(new ArrayList&lt;Specialty&gt;());</span>
<span class="fc" id="L67">			vet.setUser(user);</span>
<span class="fc" id="L68">			vetService.saveVet(vet);</span>
<span class="fc" id="L69">			break;</span>
		default:
<span class="fc" id="L71">			role = authoritiesService.findByAuthority(&quot;OWNER&quot;);</span>
<span class="fc" id="L72">			user.setAuthority(role);</span>
<span class="fc" id="L73">			userService.saveUser(user);</span>
<span class="fc" id="L74">			Owner owner = new Owner();</span>
<span class="fc" id="L75">			owner.setFirstName(request.getFirstName());</span>
<span class="fc" id="L76">			owner.setLastName(request.getLastName());</span>
<span class="fc" id="L77">			owner.setAddress(request.getAddress());</span>
<span class="fc" id="L78">			owner.setCity(request.getCity());</span>
<span class="fc" id="L79">			owner.setTelephone(request.getTelephone());</span>
<span class="fc" id="L80">			owner.setPlan(PricingPlan.BASIC);</span>
<span class="fc" id="L81">			owner.setUser(user);</span>
<span class="fc" id="L82">			ownerService.saveOwner(owner);</span>

		}

		// SI EN ALGÚN MOMENTO QUIERO MULTIPLES ROLES
		// Set&lt;String&gt; strRoles = signUpRequest.getRole();
		// Set&lt;Authorities&gt; roles = new HashSet&lt;&gt;();
		//
		// if (strRoles == null) {
		// Authorities userRole = authoritiesService.findByAuthority(Role.USER);
		// roles.add(userRole);
		// } else {
		// strRoles.forEach(role -&gt; {
		// switch (role) {
		// case &quot;admin&quot;:
		// Authorities adminRole = authoritiesService.findByAuthority(Role.ADMIN);
		// roles.add(adminRole);
		//
		// break;
		// case &quot;mod&quot;:
		// Role modRole = roleRepository.findByName(ERole.ROLE_MODERATOR)
		// .orElseThrow(() -&gt; new RuntimeException(&quot;Error: Role is not found.&quot;));
		// roles.add(modRole);
		//
		// break;
		// default:
		// Authorities userRole = authoritiesService.findByAuthority(Role.USER);
		// roles.add(userRole);
		// }
		// });
		// }

		// user.setRoles(roles);
<span class="fc" id="L115">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>